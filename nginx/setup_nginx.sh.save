#!/bin/bash

# Define Nginx directories
nginx_dir="/etc/nginx"
sites_available="$nginx_dir/sites-available"
sites_enabled="$nginx_dir/sites-enabled"
nginx_conf="$nginx_dir/nginx.conf"
project_conf_name="my_project.conf"
script_dir="$(dirname "$0")"
project_conf_path="$script_dir/$project_conf_name"

# Create sites-available and sites-enabled directories if they don't exist
if [ ! -d "$sites_available" ]; then
    echo "Creating $sites_available"
    sudo mkdir "$sites_available"
else
    echo "$sites_available already exists"
fi

if [ ! -d "$sites_enabled" ]; then
    echo "Creating $sites_enabled"
    sudo mkdir "$sites_enabled"
else
    echo "$sites_enabled already exists"
fi

# Check if nginx.conf already has the include directive for sites-enabled
include_directive="include /etc/nginx/sites-enabled/*;"
if ! grep -qE "include\s+/etc/nginx/sites-enabled/\*\s*;" "$nginx_conf"; then
    echo "Adding include directive for sites-enabled in nginx.conf"
    # Use awk to insert include directive after the http block start
    sudo awk "/http {/{print;print \"$include_directive\";next}1" "$nginx_conf" > temp && sudo mv temp "$nginx_conf"
else
    echo "nginx.conf already includes sites-enabled"
fi

# Reload Nginx to apply changes
echo "Reloading Nginx"
sudo nginx -t && sudo nginx -s reload

